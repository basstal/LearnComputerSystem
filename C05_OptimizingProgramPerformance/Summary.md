# 优化程序性能 #

## 优化编译器的能力和局限性 ##

1. 编译器必须很小心地对程序只使用**安全的**优化，典型的妨碍优化的因素有：
    - 两个指针指向同一个内存位置，也称为**内存别名使用**。
    - 函数调用。函数调用的副作用，促使编译器保持所有的函数调用不变。

## 表示程序性能 ##

1. （CPE$\cdot$n + V）表达式中n的系数CPE称为**每元素的周期数**的有效值，一般用该值来度量程序性能。

## 程序示例 ##

## 消除循环的低效率 ##

1. 代码移动，这类优化包括识别要执行多次（例如在循环里）但是计算结果不会改变的计算。因而可以将计算移动到代码前面不会被多次求值的部分。

## 减少过程调用 ##

## 消除不必要的内存引用 ##

1. 把结果累积在临时变量中。将累积值存放在局部变量acc中，消除了每次循环迭代中从内存中读出并将更新值写回的需要。

## 理解现代处理器 ##

1. 两种下界描述了程序的最大性能：
    - 延迟界限，当一系列操作必须按照严格顺序执行，下一条指令开始之前，这条指令必须结束。或代码中的数据相关限制了处理器利用指令级并行的能力。**延迟界限**给出了任何必须按照严格顺序完成合并运算的函数所需要的最小CPE值。
    - 吞吐量界限，处理器功能单元的原始计算能力，这是程序性能的终极限制。**吞吐量界限**是根据功能单元产生结果的最大速率给出CPE的最小界限。

    |   界限    | 整数+ | 整数* | 浮点数+ | 浮点数* |
    |-----------|-------|------|-------|---------|
    |延迟       |1      |3      |3      |5       |
    |吞吐量     |0.5     |1     |1      |0.5     |

2. 名词解释：
    - 指令级并行，同时对多条指令求值。
    - 超标量，在每个时钟周期执行多个操作。

3. 发射时间为1的功能单元被称为**完全流水线化的**，这些功能单元每个时钟周期可以开始一个新的运算；流水线化得功能单元实现为一系列的阶段，每个阶段完成一部分的运算，阶段的数量决定了延迟；除法器不是完全流水线化的，这意味着在开始一条新的运算之前，除法器必须完成整个除法。除法的延迟和发射时间以范围的形式给出，因为某些被除数和除数的组合比其他的组合需要更多的步骤。

4. **关键路径**，在程序的数据流表示中，不同操作之间的数据相关限制了它们的执行顺序，从而关键路径是执行一组机器指令所需时钟周期数的一个下界。

5. 对于形成循环的代码片段，可以将访问到的寄存器分为四类：
    - 只读，在循环中不会被修改，只用作源数据（数据或计算内存地址）。
    - 只写，作为数据传送操作的目的。
    - 局部，在循环内部被修改和使用，迭代与迭代之间不相关。例如条件码寄存器。
    - 循环，寄存器既作为源值，又作为目的，一次迭代中产生的值会在另一次迭代中用到。

## 循环展开 ##

1. 循环展开是一种程序变换，通过增加每次迭代计算的元素的数量，减少循环的迭代次数。

## 提高并行性 ##

1. 可以通过多路并行的方法提高程序对功能单元的并行利用率，并最终接近功能单元的吞吐量界限。

2. 浮点乘法和加法是不可结合的，由于四舍五入或溢出，多路循环展开可能得到不同的结果。因此大多数编译器并不会尝试对浮点数代码进行这种变化。

3. 通过重新结合变换（n X 1a循环展开），可以达到突破延迟界限并接近吞吐量界限的CPE。

## 优化合并代码的结果小结 ##

## 一些限制因素 ##

1. 寄存器溢出，如果并行度超过了可用的寄存器数量，那么编译器会诉诸**溢出**。

2. 预测错误惩罚，在使用**投机执行**的处理器中，处理器会开始执行预测的分支目标处的指令。它会避免修改任何实际的寄存器或内存位置，直到预测正确才把结果存储到寄存器或内存。如果预测错误，处理器必须丢弃掉所有投机执行的结果，在正确的位置，重新开始取指令的过程。为避免预测错误惩罚，因尽量书写适合用条件传送实现的代码。

## 理解内存性能 ##

1. 现代处理器有专门的功能单元来执行加载和存储操作，这些单元有内部的缓冲区来保存未完成的内存操作请求集合。

2. 对于每个被计算的元素必须加载k个值的应用，我们不可能获得低于k/2的CPE。

3. 加载操作的延迟界限为4CPE，存储操作的延迟界限为1CPE。

4. **读/写相关**，一个内存读的结果依赖于一个最近的内存写。读/写相关会导致处理速度下降。对于寄存器操作，在指令被译码成操作的时候，处理器就可以确定哪些指令会影响其他哪些指令；而对于内存操作，只有到计算出加载和存储的地址后，处理器才能确定。

## 应用：性能提高技术 ##

1. 优化程序性能的基本策略：
    - 高级设计，避免使用渐进地产生槽糕性能的算法或编码技术。
    - 基本编码原则，包括消除连续的函数调用（在可能时将计算移到循环外），消除不必要的内存引用（引入临时变量来保存中间结果。只有在最后的值计算出来时，才将结果存放到数组或全局变量中）。
    - 低级优化，包括循环展开，多个累积变量，重新结合，用功能性的风格重写条件操作。

## 确认和消除性能瓶颈 ##

## 家庭作业未完成 ##

- 17、18、19
